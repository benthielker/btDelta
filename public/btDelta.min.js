if(typeof require!=="undefined")require("./btClass.js");var btDelta=function(e,t){if(!t)t=[];t.push("btDelta");btDelta._super.call(this,e,t);this.INSERT="i";this.UPDATE="u";this.DELETE="d";this.CHANGE_KEY="ch"};btDelta._super=btClass;btClass.extend(btDelta._super,btDelta,{isFn:btClass.isFn,isObj:btClass.isObj,isArray:btClass.isArray,isNumber:btClass.isNumber,clone:btClass.clone,getNodeAtPath:function(e,t){if(typeof e==="string")e=e.substr(1).split("/");var n=t;if(btClass.isArray(e)&&e.length){for(var r=0;r<e.length;r++){var i=e[r];n=n[i]}}return n}});btDelta["delta1d"]=function(e,t){if(!t)t=[];t.push("delta1d");btDelta.delta1d._super.call(this,e,t);this.REMOVE_KEY="rm"};btDelta.delta1d._super=btDelta;btClass.extend(btDelta.delta1d._super,btDelta.delta1d,{isDelta:function(){var e=true;for(var t=0;e&&t<arguments.length;t++){var n=arguments[t];e=e&&n[this.CHANGE_KEY]!==undefined&&n[this.REMOVE_KEY]!==undefined}return e},mergeChanges:function(e,t,n){if(this.verbose>1)console.log("btDelta.delta1d.mergeChanges(","newChange:",btClass.clone(e),"oldDelta:",btClass.clone(t),"path:",n,")");if(!n)n=[];var r=e,i=t;if(t[this.CHANGE_KEY]!==undefined)if(t[this.REMOVE_KEY]!==undefined){i=t[this.CHANGE_KEY]}if(this.verbose>2)console.log("btDelta.delta1d.mergeChanges |","newChLoc:",btClass.clone(r),"oldChLoc:",btClass.clone(i),"path:",n);for(var s in r){var o=btClass.clone(n),u=r[s];o.push(s);if(this.verbose>2)console.log("btDelta.delta1d.mergeChanges ||","thisNewChLoc:",btClass.clone(u),"path:",o);if(this.isObj(u)){if(i[s]===undefined){i[s]={};if(this.verbose>3)console.log("btDelta.delta1d.mergeChanges |||","creating missing branch at path",o,"oldChLoc:",btClass.clone(i))}var a=i[s];if(this.verbose>3)console.log("btDelta.delta1d.mergeChanges ||","drilling into branch.","newChLoc:",btClass.clone(r),"thisOldChLoc:",btClass.clone(a),"path:",o);this.mergeChanges(u,a,o)}else{if(this.verbose>3)console.log("btDelta.delta1d.mergeChanges ||","applying changes to old delta.","newChLoc:",btClass.clone(u),"oldChLoc:",btClass.clone(i),"path:",o);i[s]=u}}},mergeRemoves:function(e,t,n){if(this.verbose>1)console.log("btDelta.delta1d.mergeRemoves(","newRemove:",e,"oldDelta:",t,"path:",n,")");if(!n)n=[];var r=e,i=t;if(t[this.CHANGE_KEY]!==undefined)if(t[this.REMOVE_KEY]!==undefined){i=t[this.REMOVE_KEY]}for(var s in r){var o=btClass.clone(n),u=r[s];o.push(s);if(this.isObj(u)){if(i[s]===undefined){i[s]={}}var a=i[s];this.mergeRemoves(u,a,o)}else{i[s]=u}}},newDelta:function(){var e={};e[this.CHANGE_KEY]={};e[this.REMOVE_KEY]={};return e},changeObjAndDelta:function(e,t,n){if(this.verbose>1)console.log("btDelta.delta1d.changeObjAndDelta(","change:",e,"obj:",t,"delta:",n,")");var r=this.newDelta();var i=e.p,s=e.v,e=e.c;if(typeof i==="string")i=i.substr(1).split("/");if(i===undefined||!this.isArray(i)||!i.length){throw new Error("btDelta.delta1d.changeObjAndDelta ERROR: "+"No valid property path specified.");return false}var o=t,u=r[this.CHANGE_KEY];removeLoc=r[this.REMOVE_KEY];for(var a=0;a<i.length-1;a++){var f=i[a];o=o[f];if(e===this.DELETE){if(removeLoc[f]===undefined)removeLoc[f]={};removeLoc=removeLoc[f]}else{if(u[f]===undefined)u[f]={};u=u[f]}}var l=i[a];if(this.verbose>2)console.log("btDelta.delta1d.changeObjAndDelta |","change/remove structure created","thisDelta["+this.REMOVE_KEY+"]:",btClass.clone(r[this.REMOVE_KEY]),"thisDelta["+this.CHANGE_KEY+"]:",btClass.clone(r[this.CHANGE_KEY]),"lastProp:",l);if(e===this.DELETE){removeLoc[l]=0;o=this.applyRemove(removeLoc,o)}else{u[l]=s;o=this.applyChange(u,o)}if(this.verbose>2)console.log("btDelta.delta1d.changeObjAndDelta |","applied delta to object","removeLoc:",removeLoc,"changeLoc:",u);if(!n)n=r;else{if(e===this.DELETE)this.mergeRemoves(r[this.REMOVE_KEY],n);else this.mergeChanges(r[this.CHANGE_KEY],n)}return n},doUpdateItem:function(e,t,n,r,i){if(this.verbose)console.log("btDelta.delta1d.doDeleteItem(","newValue:",e,"itemAt:",t,"inParentPath:",n,"obj:",r,"delta:",i,")");if(typeof n==="string")n=n.substr(1).split("/");var s=this.clone(n);s.push(t);var o={c:this.UPDATE,p:s,v:e};return this.changeObjAndDelta(o,r,i)},doInsertItem:function(e,t,n,r,i){if(this.verbose)console.log("btDelta.delta1d.doDeleteItem(","value:",e,"insertAt:",t,"inParentPath:",n,"obj:",r,"delta:",i,")");if(typeof n==="string")n=n.substr(1).split("/");var s=this.clone(n);s.push(t);var o={c:this.INSERT,p:s,v:e};return this.changeObjAndDelta(o,r,i)},doDeleteItem:function(e,t,n,r){if(this.verbose)console.log("btDelta.delta1d.doDeleteItem(","deleteFrom:",e,"inParentPath:",t,"obj:",n,"delta:",r,")");if(typeof t==="string")t=t.substr(1).split("/");var i=this.clone(t);if(this.verbose>1)console.log("btDelta.delta1d.doDeleteItem |","inParentPath:",btClass.clone(t),"deleteItemPath:",btClass.clone(i));i.push(e);var s={c:this.DELETE,p:i};return this.changeObjAndDelta(s,n,r)},doMoveItem:function(e,t,n,r,i){if(this.verbose)console.log("btDelta.delta1d.doMoveItem(","moveFrom:",e,"moveTo:",t,"inParentPath:",n,"obj:",r,"delta:",i,")");if(!i)i=this.newDelta();if(typeof n==="string")n=n.substr(1).split("/");var s=this.getNodeAtPath(n,r),o=this.clone(n),u=this.clone(n);o.push(e);u.push(t);var a=this.getNodeAtPath(o,r),f=this.getNodeAtPath(u,r),l=[{c:this.UPDATE,p:o,v:f},{c:this.UPDATE,p:u,v:a}];this._rootDelta=i;for(var c=0;c<l.length;c++){i=this.changeObjAndDelta(l[c],r,i)}return i},compare:function(e,t){var n=this.compareObjs(e,t),r={};r[this.CHANGE_KEY]=n[0];r[this.REMOVE_KEY]=n[1];return r},compareObjs:function(e,t){if(this.verbose>1)console.log("btDelta.delta1d.compareObjs(","oldObj:",btClass.clone(e),"newObj:",btClass.clone(t),")");var n={},r={};if(e!==undefined)for(var i in e){var s=e[i],o=t[i];if(!this.isFn(s)&&!this.isFn(o))if(this.isObj(s)&&this.isObj(o)){if(this.verbose>2)console.log("btDelta.delta1d.compareObjs | drilling into retained branch.");var u=this.compareObjs(s,o),a=Object.getOwnPropertyNames(u[0]).length,f=Object.getOwnPropertyNames(u[1]).length;if(a)n[i]=u[0];if(f)r[i]=u[1]}else if(this.isObj(s)&&o!==undefined){if(this.verbose>2)console.log("btDelta.delta1d.compareObjs | removing old branch.");r[i]=0}else if(s!==undefined&&this.isObj(o)){if(this.verbose>2)console.log("btDelta.delta1d.compareObjs | adding new branch.");n[i]=o}else{var l=this.compareVals(s,o);if(this.verbose>2)console.log("btDelta.delta1d.compareObjs | comparing values:",l);if(l){if(l===this.DELETE){if(this.verbose>3)console.log("btDelta.delta1d.compareObjs || deleting value.");r[i]=0}else{if(this.verbose>3)console.log("btDelta.delta1d.compareObjs || applying new/changed value.");n[i]=o}}else{if(n[i]!==undefined){if(this.verbose>3)console.log("btDelta.delta1d.compareObjs || removing value.");delete n[i]}else{if(this.verbose>3)console.log("btDelta.delta1d.compareObjs || ignoring value.")}}}}for(var c in t)if(!e||e[c]===undefined){var o=t[c];if(!this.isFn(o))if(this.isObj(o)){if(this.verbose>2)console.log("btDelta.delta1d.compareObjs | drilling into new branch.");var u=this.compareObjs(null,o);n[c]=u[0]}else{if(this.verbose>2)console.log("btDelta.delta1d.compareObjs | adding new value.");n[c]=o}}if(this.verbose>1)console.log("btDelta.delta1d.compareObjs |","changes:",n,"deletes:",r);return[n,r]},compareVals:function(e,t){if(e==t)return false;if(this.isFn(e)||this.isFn(t))return false;if(t!==undefined&&e===undefined)return this.UPDATE;if(t===undefined&&e!==undefined)return this.DELETE;return this.UPDATE},applyDeltaToObj:function(e,t){if(this.verbose)console.log("btDelta.delta1d.applyDeltaToObj(","delta:",btClass.clone(e),"obj:",btClass.clone(t),")");var n=btClass.clone(t);if(e[this.REMOVE_KEY]!==undefined)n=this.applyRemove(e[this.REMOVE_KEY],n);if(e[this.CHANGE_KEY]!==undefined)n=this.applyChange(e[this.CHANGE_KEY],n);return n},applyChange:function(e,t){for(var n in e){if(this.isObj(e[n])){if(t[n]===undefined)t[n]={};t[n]=this.applyChange(e[n],t[n])}else{t[n]=e[n]}}return t},applyRemove:function(e,t){for(var n in e){if(this.isObj(e[n])){t[n]=this.applyRemove(e[n],t[n])}else if(e[n]==0){if(this.isArray(t)){t.splice(n,1)}else{delete t[n]}}}return t}});btDelta["delta2d"]=function(e,t){if(!t)t=[];t.push("delta2d");btDelta.delta2d._super.call(this,e,t);this.DELTA_KEY="d";this.DELTA_VAL="$";this.CACHE_KEY="ca";this.CACHE_PRE="$d"};btDelta.delta2d._super=btDelta;btClass.extend(btDelta.delta2d._super,btDelta.delta2d,{isDelta:function(){var e=true;for(var t=0;e&&t<arguments.length;t++){var n=arguments[t];e=e&&n[this.CHANGE_KEY]!==undefined}return e},isCacheKey:function(){var e=true;for(var t=0;e&&t<arguments.length;t++){var n=arguments[t];e=e&&typeof n==="string"&&n.substr(0,2)==this.CACHE_PRE}return e},isChangeLeaf:function(e){var t=true;for(var n=0;t&&n<arguments.length;n++){var r=arguments[n];t=t&&r[this.DELTA_KEY]!==undefined&&r[this.DELTA_KEY]===this.DELTA_VAL&&(r.v!==undefined||r.o!==undefined)&&r.c!==undefined}return t},mergeDeltas:function(e,t,n){if(this.verbose>1)console.log("btDelta.delta2d.mergeDeltas(","newDelta:",e,"oldDelta:",t,"path:",n,")");if(!n)n=[];var r=e,i=t;if(e[this.CHANGE_KEY]!==undefined){r=e[this.CHANGE_KEY];i=t[this.CHANGE_KEY]}for(var s in e){n.push(s);r=e[s];if(this.isChangeLeaf(r)){i[s]=r}else if(this.isObj(r)){if(t[s]===undefined){t[s]={}}i=t[s];this.mergeDeltas(r,i,n)}}},newDelta:function(){var e={};e[this.CHANGE_KEY]={};return e},addToCache:function(e,t){if(!t)t=this.newDelta();if(t[this.CACHE_KEY]===undefined)t[this.CACHE_KEY]=[];t[this.CACHE_KEY].push(e);return this.CACHE_PRE+t[this.CACHE_KEY].length},getFromCache:function(e,t){if(!t&&this._rootDelta)t=this._rootDelta;if(t&&t[this.CACHE_KEY]){e=e.replace(this.CACHE_PRE,"")-1;return t[this.CACHE_KEY][e]}},changeObjAndDelta:function(e,t,n){if(this.verbose>1)console.log("btDelta.delta2d.changeObjAndDelta(","change:",e,"obj:",t,"delta:",n,")");var r=this.newDelta();var i=e.p,s=e.v,o=e.o,e=e.c;if(typeof i==="string")i=i.substr(1).split("/");if(i===undefined||!this.isArray(i)||!i.length){throw new Error("btDelta.delta2d.changeObjAndDelta ERROR: "+"No valid property path specified.");return false}var u=t,a=r[this.CHANGE_KEY];for(var f=0;f<i.length-1;f++){var l=i[f];u=u[l];if(a[l]===undefined)a[l]={};a=a[l]}var c=i[f];var h={c:e};h[this.DELTA_KEY]=this.DELTA_VAL;if(e==this.DELETE){h["v"]=o||u[c]}else if(e==this.INSERT){h["v"]=s}else{h["o"]=o||u[c];h["v"]=s}a[c]=h;if(this.verbose>2)console.log("btDelta.delta2d.changeObjAndDelta |","produced changeLeaf:",h);u=this.applyDelta(a,u);if(!n)n=r;else this.mergeDeltas(r,n);return n},doUpdateItem:function(e,t,n,r,i){if(this.verbose)console.log("btDelta.delta2d.doDeleteItem(","newValue:",e,"itemAt:",t,"inParentPath:",n,"obj:",r,"delta:",i,")");if(typeof n==="string")n=n.substr(1).split("/");var s=this.clone(n);s.push(t);var o={c:this.UPDATE,p:s,v:e};return this.changeObjAndDelta(o,r,i)},doInsertItem:function(e,t,n,r,i){if(this.verbose)console.log("btDelta.delta2d.doDeleteItem(","value:",e,"insertAt:",t,"inParentPath:",n,"obj:",r,"delta:",i,")");if(typeof n==="string")n=n.substr(1).split("/");var s=this.clone(n);s.push(t);var o={c:this.INSERT,p:s,v:e};return this.changeObjAndDelta(o,r,i)},doDeleteItem:function(e,t,n,r){if(this.verbose)console.log("btDelta.delta2d.doDeleteItem(","deleteFrom:",e,"inParentPath:",t,"obj:",n,"delta:",r,")");if(typeof t==="string")t=t.substr(1).split("/");var i=this.clone(t);if(this.verbose>1)console.log("btDelta.delta2d.doDeleteItem |","inParentPath:",btClass.clone(t),"deleteItemPath:",btClass.clone(i));i.push(e);var s={c:this.DELETE,p:i};return this.changeObjAndDelta(s,n,r)},doMoveItem:function(e,t,n,r,i){if(this.verbose)console.log("btDelta.delta2d.doMoveItem(","moveFrom:",e,"moveTo:",t,"inParentPath:",n,"obj:",r,"delta:",i,")");if(!i)i=this.newDelta();if(typeof n==="string")n=n.substr(1).split("/");var s=this.getNodeAtPath(n,r),o=this.clone(n),u=this.clone(n);o.push(e);u.push(t);var a=this.addToCache(this.getNodeAtPath(o,r),i),f=this.addToCache(this.getNodeAtPath(u,r),i),l=[{c:this.UPDATE,p:o,v:f,o:a},{c:this.UPDATE,p:u,v:a,o:f}];this._rootDelta=i;for(var c=0;c<l.length;c++){i=this.changeObjAndDelta(l[c],r,i)}return i},applyDeltaToObj:function(e,t,n){if(this.verbose)console.log("btDelta.delta2d.applyDeltaToObj(","delta:",e,"obj:",t,"reverse:",n,")");var r=this.clone(t);this._rootDelta=e;r=this.applyDelta(e[this.CHANGE_KEY],r,n);return r},applyDelta:function(e,t,n){if(this.verbose>1)console.log("btDelta.delta2d.applyDelta(","delta:",e,"obj:",t,"reverse:",n,")");var r=function(r){var i=e[r];if(this.isObj(i)){var s=!this.isChangeLeaf(i);if(s){t[r]=this.applyDelta(i,t[r],n)}else{var o=i.c,u=i.v,a=i.o!==undefined?i.o:null;if(u&&this.isCacheKey(u))u=this.getFromCache(u);if(a&&this.isCacheKey(a))a=this.getFromCache(a);if(n){if(o==this.INSERT)o=this.DELETE;else if(o==this.DELETE)o=this.INSERT;else if(o==this.UPDATE){var f=u;u=a;a=f}}if(o==this.DELETE){if(this.isArray(t)){t.splice(r,1)}else{delete t[r]}}else if(o==this.INSERT&&this.isArray(t)){t.splice(r,0,u)}else{t[r]=u}}}};if(n){var i=[];for(var s in e)i.push(s);for(var o=i.length-1;o>=0;o--){var s=i[o];r.call(this,s)}}else{for(var s in e)r.call(this,s)}return t},compare:function(e,t){var n=this.newDelta();n[this.CHANGE_KEY]=this.compareObjs(e,t);return n},compareObjs:function(e,t){var n={};if(e)for(var r in e){var i=e[r],s=t[r];if(!this.isFn(i)&&!this.isFn(s))if(this.isObj(i)&&this.isObj(s)){var o=this.compareObjs(i,s),u=Object.getOwnPropertyNames(o).length;if(u)n[r]=o}else{if(this.isObj(i)&&s===undefined){n[r]={c:this.DELETE,v:i}}else if(i===undefined&&this.isObj(s)){n[r]={c:this.INSERT,v:s}}else{var a=this.compareVals(i,s);if(a){if(a===this.DELETE)n[r]={c:a,v:i};else if(a===this.UPDATE)n[r]={c:a,v:s,o:i};else n[r]={c:a,v:s}}else{if(n[r]!==undefined)delete n[r]}}if(n[r]!==undefined)n[r][this.DELTA_KEY]=this.DELTA_VAL}}for(var f in t)if(!e||e[f]===undefined){var s=t[f];if(!this.isFn(s)){n[f]={c:this.INSERT,v:s};n[f][this.DELTA_KEY]=this.DELTA_VAL}}return n},compareVals:function(e,t){if(e===t)return false;if(this.isFn(e)||this.isFn(t))return false;if(e===undefined&&t!==undefined)return this.UPDATE;if(e!==undefined&&t===undefined)return this.DELETE;return this.UPDATE}});if(typeof module!=="undefined")module.exports=btDelta